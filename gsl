#!/bin/bash
VIDDIR=/home/henning/Videoklipp/sleeplab
cd $VIDDIR
IPCAM=$2
FILES=$1
MODEL=$3
if [ -z "$1" ]; then
  FILES=100
fi
if [ -z "$2" ]; then
  IPCAM=192.168.0.110
fi
if [ -z "$3"]; then
   MODEL=DCS-936L
fi
#echo "Fetching latest $FILES video files from $MODEL camera at $IPCAM"
LOGOPT="--anyauth -u admin: --data 'export=true' -s --compressed -v"
SDOPT="--anyauth -u admin: -v -J --compressed"
# Max. command line size bash; getconf ARG_MAX
#https://stackoverflow.com/questions/19354870/bash-command-line-and-input-limit
#curl $LOGOPT "http://$IPCAM/eng/admin/export_log.cgi" -e "http://$IPCAM/eng/web_log.cgi"  |\
# grep -E 'Motion'.*'SD Card is OK' | tail -n $FILES | cut -d' ' -f4 | { while read FILENAME ; do FILEPATH=$MODEL/${FILENAME:0:8}/${FILENAME:9:2}/$FILENAME;\
# curl $SDOPT -e "http://$IPCAM/eng/admin/adv_sdcard.cgi" -O "http://$IPCAM/cgi/admin/getSDFile.cgi?file=$FILENAME&path=$FILEPATH" ; done }
# Let curl reuse existing connection (persistent-connection) until server closes connection by sending "Connection: close"
#curl --anyauth -u admin: --data 'export=true' -s --compressed -v "http://$IPCAM/eng/admin/export_log.cgi" -e "http://$IPCAM/eng/web_log.cgi"|\
# grep -E 'Motion'.*'SD Card is OK' | tail -n $FILES | cut -d' ' -f4 | { while read FILENAME ; do FILEPATH=$MODEL/${FILENAME:0:8}/${FILENAME:9:2}/$FILENAME;\
# URLOPT+="-O http://$IPCAM/cgi/admin/getSDFile.cgi?file=$FILENAME&path=$FILEPATH ";\
#  done; curl --anyauth -u admin: -v -J --compressed -e "http://$IPCAM/eng/admin/adv_sdcard.cgi" $URLOPT; }
echo "Fetching motion log from camera..."
curl --anyauth -u admin: --data 'export=true' -s --compressed "http://$IPCAM/eng/admin/export_log.cgi" -e "http://$IPCAM/eng/web_log.cgi"|\
 tee "/home/henning/Nedlastinger/camera-$MODEL.log" | grep -E 'Motion'.*'SD Card is OK' | cut -d' ' -f4 | { while read FILENAME ; do FILEPATH=$MODEL/${FILENAME:0:8}/${FILENAME:9:2}/$FILENAME;\
 if [ ! -f $FILENAME ]; then URLOPT+="-O http://$IPCAM/cgi/admin/getSDFile.cgi?file=$FILENAME&path=$FILEPATH ";\
  #else echo "$FILENAME already downloaded"; 
 fi\
  done; if [ ${#URLOPT} -gt 0 ]; then echo "Fetching video from camera at $IPCAM"; curl --anyauth -u admin: -J --compressed -s -e "http://$IPCAM/eng/admin/adv_sdcard.cgi" $URLOPT; else\
  echo "No new videos, skipping download"; fi }
cd - >/dev/null
